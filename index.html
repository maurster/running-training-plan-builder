<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Running Training Plan Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg: #f6f7fb;
    --card: #fff;
    --text: #1f2937;
    --muted: #6b7280;
    --brand:#2563eb;
    --border:#d1d5db;
  }
  *{box-sizing:border-box}
  /* Font stack matching Tailwind's default (Inter first if available) */
  body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';background:linear-gradient(135deg,#eef5ff 0%,#f3e8ff 100%) fixed;color:var(--text)}
  .container{max-width:860px;margin:20px auto;padding:12px} /* narrower canvas */
  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px}
  h1{margin:0;font-size:28px;font-weight:800;color:#1f2937}
  .title-input{width:100%;font-size:28px;font-weight:800;border:0;border-bottom:2px solid #93c5fd;padding:6px 2px;outline:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{border:0;border-radius:8px;padding:10px 14px;cursor:pointer;font-weight:400;display:inline-flex;gap:8px;align-items:center;font-size:14px;line-height:1;justify-content:center;text-align:center}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-blue{background:#2563eb;color:#fff}
  .btn-purple{background:#7c3aed;color:#fff}
  .btn-indigo{background:#4f46e5;color:#fff}
  .btn-green{background:#16a34a;color:#fff}
  .btn-gray{background:#6b7280;color:#fff}
  .btn-red{background:#dc2626;color:#fff}
  .btn-blue:hover{background:#1e40af}
  .btn-purple:hover{background:#5b21b6}
  .btn-indigo:hover{background:#3730a3}
  .btn-green:hover{background:#15803d}
  .btn-gray:hover{background:#4b5563}
  .btn-red:hover{background:#b91c1c}
  label{font-weight:400;color:#374151} /* no bold label on splash */
  input[type="number"],input[type="text"],input[type="date"],select,textarea{
    border:1px solid var(--border);border-radius:8px;padding:8px 10px;outline:none
  }
  input:focus,select:focus,textarea:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .switch{position:relative;width:44px;height:24px;background:#d1d5db;border-radius:999px;cursor:pointer;display:inline-block;vertical-align:middle}
  .switch[data-on="true"]{background:#2563eb}
  .knob{position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .18s}
  .switch[data-on="true"] .knob{transform:translateX(20px)}
  .notice{margin-top:10px;background:#ecfdf5;border:1px solid #34d399;color:#065f46;padding:8px 10px;border-radius:8px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb}
  th{background:#111827;color:#fff;padding:10px;font-size:14px;text-align:center;vertical-align:middle;font-weight:400;line-height:1.6} /* headers not bold; more space */
  td{padding:8px;vertical-align:top}
  .week-col{width:48px;text-align:center;vertical-align:middle;font-weight:400}
  .day-col{width:160px}
  .mileage-col{width:80px;text-align:center;vertical-align:middle;font-weight:400;color:#ffffff} /* header text white already; body cells not forced */
  .actions-col{width:96px;text-align:center;vertical-align:middle}
  .cell{min-height:90px;border-radius:8px;padding:8px;cursor:move;transition:opacity .15s}
  .cell:hover{opacity:.9}
  .date-badge{font-size:10px;color:#6b7280;font-weight:700;margin-bottom:4px}
  .type{font-weight:700;font-size:13px}
  .dist{font-size:12px;margin-top:3px;color:#374151}
  .details{font-size:12px;margin-top:3px;color:#4b5563;white-space:pre-wrap;word-break:break-word}
  .edit-wrap{display:flex;flex-direction:column;gap:6px;min-width:220px}
  .edit-actions{display:flex;gap:6px}
  .icon-btn{border:0;border-radius:8px;padding:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:14px}
  .icon-btn.green{background:#22c55e;color:#fff}
  .icon-btn.gray{background:#6b7280;color:#fff}
  .icon-btn.blue{background:#3b82f6;color:#fff}
  .icon-btn.red{background:#ef4444;color:#fff}
  .cell-actions{display:flex;gap:6px;justify-content:center}
  .pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:600}
  .pill button{background:transparent;border:0;cursor:pointer;padding:2px 6px;border-radius:999px}
  .pill button:hover{background:#ef4444;color:#fff}
  .footer-note{color:#6b7280;font-size:12px;margin-top:8px}
  .stack{display:flex;flex-direction:column;gap:12px} /* stack splash items vertically */
  .field-group{display:flex;flex-direction:column;gap:8px} /* label above input */
  .nowrap{white-space:nowrap}
  .gap-2{gap:8px}
</style>
</head>
<body>
<div class="container">
  <!-- Splash / Creator -->
  <div id="splash" class="card">
    <h1>Running Training Plan Builder</h1>
    <div style="height:8px"></div>
    <div class="stack">
      <div class="field-group">
        <label for="weeksInput">How many weeks do you want to train?</label>
        <input id="weeksInput" type="number" min="1" max="52" value="12" />
      </div>
      <button class="btn btn-blue" id="createBtn">Create Training Plan</button>
      <button class="btn btn-purple" id="loadSavedBtn">Load Saved Plan</button>
      <label class="btn btn-indigo" style="cursor:pointer">
        Import Training Plan
        <input id="importFile" type="file" accept=".json" style="display:none" />
      </label>
    </div>
    <div id="splashMsg" class="notice" style="display:none"></div>
  </div>

  <!-- App -->
  <div id="app" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="flex:1;min-width:240px">
          <h1 id="titleDisplay" class="clickable" title="Click to edit title">My Training Plan</h1>
          <input id="titleInput" class="title-input" style="display:none" />
        </div>
        <div class="row gap-2 nowrap">
          <button class="btn btn-blue" id="saveBtn" title="Save">Save</button>
          <button class="btn btn-purple" id="exportBtn" title="Export plan as file">Export</button>
          <label class="btn btn-indigo" style="cursor:pointer" title="Import">
            Import
            <input id="importFileTop" type="file" accept=".json" style="display:none" />
          </label>
          <button class="btn btn-green" id="downloadHtmlBtn" title="Download HTML">Download HTML</button>
          <button class="btn btn-gray" id="newBtn" title="New Plan">New Plan</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <label>Show dates:</label>
        <div id="showDatesSwitch" class="switch" data-on="false" role="button" aria-label="toggle dates"><div class="knob"></div></div>
        <label for="startDate">Start date:</label>
        <input id="startDate" type="date" />
      </div>

      <div id="saveMsg" class="notice" style="display:none;margin-top:12px"></div>
    </div>

    <div class="card" style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th class="week-col">Week</th>
            <th class="day-col">Monday</th>
            <th class="day-col">Tuesday</th>
            <th class="day-col">Wednesday</th>
            <th class="day-col">Thursday</th>
            <th class="day-col">Friday</th>
            <th class="day-col">Saturday</th>
            <th class="day-col">Sunday</th>
            <th class="mileage-col">Weekly<br/>Mileage</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody id="planBody"></tbody>
      </table>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px 0;font-size:20px">Add Workout Type</h2>
      <div class="row">
        <input id="newWorkoutName" type="text" placeholder="Enter workout name" style="flex:1;min-width:240px" />
        <button class="btn btn-blue" id="addWorkoutBtn">Add Workout</button>
      </div>
      <div id="customWrap" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ===== Data & Helpers ===== */
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

const DEFAULT_WORKOUT_TYPES = [
  { value:'rest', label:'Rest', color:'bg-gray' },
  { value:'easy', label:'Easy Run', color:'bg-blue' },
  { value:'interval', label:'Interval', color:'bg-red' },
  { value:'long', label:'Long Run', color:'bg-purple' },
  { value:'progressive', label:'Progressive Run', color:'bg-indigo' },
  { value:'tempo', label:'Tempo Run', color:'bg-orange' },
  { value:'strength', label:'Strength', color:'bg-green' },
  { value:'race', label:'Race', color:'bg-pink' },
];

const CUSTOM_COLORS = [
  'bg-cyan','bg-yellow','bg-lime','bg-amber','bg-emerald',
  'bg-teal','bg-sky','bg-violet','bg-fuchsia','bg-rose'
];

let weeks = 12;
let plan = {}; // {1:{Monday:{type,details,mileage},...},...}
let editing = null; // {week, day}
let temp = { type:'rest', mileage:'', details:'' };
let planTitle = 'My Training Plan';
let customWorkouts = [];
let showDates = false;
let startDate = (new Date()).toISOString().split('T')[0];
let dragged = null; // {week, day, data}

function allTypes(){
  return [...DEFAULT_WORKOUT_TYPES, ...customWorkouts];
}
function ensureCustomColors(){
  // assign colours to custom workouts if missing
  customWorkouts = (customWorkouts||[]).map((w, i)=>{
    if(!w.color){
      const idx = i % CUSTOM_COLORS.length;
      return { ...w, color: CUSTOM_COLORS[idx] };
    }
    return w;
  });
}

function getWorkoutColor(type){
  const w = allTypes().find(x=>x.value===type);
  return w && w.color ? w.color : 'bg-gray';
}
function getWorkoutLabel(type){
  const w = allTypes().find(x=>x.value===type);
  return w ? w.label : 'Rest';
}
function weeklyMileage(week){
  if(!plan[week]) return '0.0';
  return DAYS.reduce((t,d)=> t + (Number(plan[week][d]?.mileage||0)), 0).toFixed(1);
}
function initEmptyPlan(n){
  const p={};
  for(let w=1; w<=n; w++){
    p[w]={};
    DAYS.forEach(d=>{
      p[w][d]={ type:'rest', details:'', mileage:0 };
    });
  }
  return p;
}
function getDateForCell(week, dayIndex){
  if(!startDate) return '';
  const start = new Date(startDate + 'T00:00:00');
  const dow = start.getDay(); // 0 Sun, 1 Mon
  const sub = (dow===0?6:dow-1);
  start.setDate(start.getDate()-sub);
  const daysToAdd = (Number(week)-1)*7 + dayIndex;
  const cellDate = new Date(start);
  cellDate.setDate(start.getDate()+daysToAdd);
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  return cellDate.getDate() + ' ' + months[cellDate.getMonth()];
}

/* ===== Persistence ===== */
function saveToLocal(){
  try{
    const data = {
      plan, title:planTitle, customWorkouts, showDates, startDate,
      savedDate: new Date().toISOString()
    };
    localStorage.setItem('trainingPlan', JSON.stringify(data));
    flashMsg('saveMsg','Plan saved successfully!');
  }catch(e){
    flashMsg('saveMsg','Error saving plan. Plan may be too large.');
  }
}
function tryLoadSaved(showToast=true){
  try{
    const s = localStorage.getItem('trainingPlan');
    if(!s){ if(showToast) flashMsg('splashMsg','No saved plan found.'); return false; }
    const data = JSON.parse(s);
    if(!data || !data.plan || Object.keys(data.plan).length===0){ if(showToast) flashMsg('splashMsg','No saved plan found.'); return false; }
    plan = data.plan || {};
    planTitle = data.title || 'My Training Plan';
    customWorkouts = data.customWorkouts || [];
    ensureCustomColors();
    weeks = Object.keys(plan).length;
    showDates = !!data.showDates;
    if(data.startDate) startDate = data.startDate;
    if(showToast) flashMsg('splashMsg','Saved plan loaded successfully!');
    enterApp();
    return true;
  }catch(e){
    if(showToast) flashMsg('splashMsg','Error loading plan.');
    return false;
  }
}

/* ===== UI Builders ===== */
function flashMsg(id,text){
  const el = document.getElementById(id);
  el.textContent = text;
  el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 2500);
}

function renderSplash(){
  document.getElementById('splash').style.display = (Object.keys(plan).length===0)?'block':'none';
  document.getElementById('app').style.display = (Object.keys(plan).length===0)?'none':'block';
}

function enterApp(){
  renderSplash();
  document.getElementById('titleDisplay').textContent = planTitle;
  document.getElementById('titleInput').value = planTitle;
  const sd = document.getElementById('startDate');
  sd.value = startDate;
  const sw = document.getElementById('showDatesSwitch');
  sw.setAttribute('data-on', showDates ? 'true' : 'false');
  renderCustomList();
  renderTable();
}

function renderCustomList(){
  const wrap = document.getElementById('customWrap');
  wrap.innerHTML = '';
  if(customWorkouts.length===0){
    return;
  }
  const frag = document.createDocumentFragment();
  customWorkouts.forEach(w=>{
    const span = document.createElement('span');
    span.className = `pill ${w.color}`;
    span.innerHTML = `${w.label} <button data-remove="${w.value}" title="Remove">Ã—</button>`;
    frag.appendChild(span);
  });
  wrap.appendChild(frag);
}

function renderTable(){
  const tbody = document.getElementById('planBody');
  tbody.innerHTML = '';
  Object.keys(plan).forEach(week=>{
    const tr = document.createElement('tr');

    const tdWeek = document.createElement('td');
    tdWeek.className = 'week-col';
    tdWeek.textContent = week;
    tr.appendChild(tdWeek);

    DAYS.forEach((day, idx)=>{
      const td = document.createElement('td');
      td.className = 'day-col';
      const isEditing = editing && editing.week==week && editing.day===day;
      const cell = plan[week][day];

      if(isEditing){
        const wrap = document.createElement('div');
        wrap.className = 'edit-wrap';

        const sel = document.createElement('select');
        allTypes().forEach(t=>{
          const op = document.createElement('option');
          op.value = t.value; op.textContent = t.label;
          if(t.value===temp.type) op.selected = true;
          sel.appendChild(op);
        });
        sel.addEventListener('change', e=>{
          temp.type = e.target.value;
          if(temp.type==='rest') temp.mileage = '0'; // set 0 when choosing rest
        });

        const dist = document.createElement('input');
        dist.type='number'; dist.min='0'; dist.step='1'; dist.placeholder='Distance';
        dist.value = temp.mileage;
        dist.addEventListener('input', e=> temp.mileage = e.target.value);

        const ta = document.createElement('textarea');
        ta.rows=2; ta.placeholder='Details (e.g., 6x800m @ 5K pace)';
        ta.value = temp.details;
        ta.addEventListener('input', e=> temp.details = e.target.value);

        const actions = document.createElement('div');
        actions.className='edit-actions';

        const bSave = document.createElement('button');
        bSave.className='icon-btn green'; bSave.title='Save'; bSave.textContent='Save';
        bSave.addEventListener('click', saveEditing);

        const bCancel = document.createElement('button');
        bCancel.className='icon-btn gray'; bCancel.title='Cancel'; bCancel.textContent='Cancel';
        bCancel.addEventListener('click', cancelEditing);

        actions.appendChild(bSave); actions.appendChild(bCancel);
        wrap.appendChild(sel); wrap.appendChild(dist); wrap.appendChild(ta); wrap.appendChild(actions);
        td.appendChild(wrap);
      }else{
        const box = document.createElement('div');
        box.className = `cell ${getWorkoutColor(cell.type)}`;
        box.setAttribute('draggable','true');
        box.addEventListener('click', ()=> startEditing(week, day));
        box.addEventListener('dragstart', e=> onDragStart(e, week, day));
        box.addEventListener('dragover', e=> e.preventDefault());
        box.addEventListener('drop', e=> onDrop(e, week, day));

        if(showDates && startDate){
          const db = document.createElement('div');
          db.className='date-badge';
          db.textContent = getDateForCell(week, idx);
          box.appendChild(db);
        }
        const t = document.createElement('div');
        t.className='type';
        t.textContent = getWorkoutLabel(cell.type);
        box.appendChild(t);

        if(Number(cell.mileage)>0){
          const d = document.createElement('div');
          d.className='dist';
          d.textContent = cell.mileage;
          box.appendChild(d);
        }
        if(cell.details){
          const de = document.createElement('div');
          de.className='details';
          de.textContent = cell.details;
          box.appendChild(de);
        }
        td.appendChild(box);
      }
      tr.appendChild(td);
    });

    const tdMiles = document.createElement('td');
    tdMiles.className='mileage-col';
    tdMiles.textContent = weeklyMileage(week);
    tr.appendChild(tdMiles);

    const tdActions = document.createElement('td');
    tdActions.className='actions-col';
    const wrap = document.createElement('div');
    wrap.className='cell-actions';

    if(week==='1'){
      const before = document.createElement('button');
      before.className='icon-btn green'; before.title='Insert week before Week 1';
      before.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v8M8 12h8"></path></svg>`;
      before.addEventListener('click', ()=> insertWeek(0));
      wrap.appendChild(before);
    }
    const after = document.createElement('button');
    after.className='icon-btn blue'; after.title='Insert week after this';
    after.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v8M8 12h8"></path></svg>`;
    after.addEventListener('click', ()=> insertWeek(Number(week)));
    wrap.appendChild(after);

    const del = document.createElement('button');
    del.className='icon-btn red'; del.title='Delete this week';
    del.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6M14 11v6"></path></svg>`;
    del.addEventListener('click', ()=>{
      if(Object.keys(plan).length>1) deleteWeek(Number(week));
      else alert('Cannot delete the last week');
    });
    wrap.appendChild(del);

    tdActions.appendChild(wrap);
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  });
}

/* ===== Title click-to-edit ===== */
const titleDisplay = document.getElementById('titleDisplay');
const titleInput = document.getElementById('titleInput');
titleDisplay.addEventListener('click', ()=>{
  titleDisplay.style.display='none';
  titleInput.style.display='block';
  titleInput.value = planTitle;
  titleInput.focus();
});
titleInput.addEventListener('blur', ()=>{
  planTitle = titleInput.value || 'My Training Plan';
  titleDisplay.textContent = planTitle;
  titleInput.style.display='none';
  titleDisplay.style.display='block';
});
titleInput.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    titleInput.blur();
  }
});

/* ===== Editing ===== */
function startEditing(week, day){
  const c = plan[week][day] || {type:'rest',details:'',mileage:0};
  editing = {week,day};
  temp.type = c.type;
  temp.details = c.details;
  temp.mileage = String(c.mileage??'');
  renderTable();
}
function saveEditing(){
  if(!editing) return;
  const w = editing.week, d = editing.day;
  if(!plan[w]) plan[w] = {};
  const mileageVal = (temp.type === 'rest') ? 0 : (parseFloat(temp.mileage)||0); // force 0 for rest
  plan[w][d] = {
    type: temp.type,
    details: temp.details || '',
    mileage: mileageVal
  };
  editing = null;
  temp = { type:'rest', mileage:'', details:'' };
  renderTable();
}
function cancelEditing(){
  editing = null;
  temp = { type:'rest', mileage:'', details:'' };
  renderTable();
}

/* ===== Drag & Drop ===== */
function onDragStart(e, week, day){
  dragged = { week, day, data: {...plan[week][day]} };
  e.dataTransfer.effectAllowed = 'move';
}
function onDrop(e, targetWeek, targetDay){
  e.preventDefault();
  if(!dragged) return;
  const { week:sw, day:sd, data } = dragged;
  if(sw==targetWeek && sd===targetDay){ dragged=null; return; }
  const tmp = {...plan[targetWeek][targetDay]};
  plan[targetWeek][targetDay] = data;
  plan[sw][sd] = tmp;
  dragged = null;
  renderTable();
}

/* ===== Weeks ops ===== */
function insertWeek(afterWeek){
  const newPlan = {};
  let cur = 1;
  if(afterWeek===0){
    newPlan[1] = {};
    DAYS.forEach(d=> newPlan[1][d]={type:'rest',details:'',mileage:0});
    cur=2;
    Object.keys(plan).forEach(w=>{ newPlan[cur]=plan[w]; cur++; });
  }else{
    const total = Object.keys(plan).length;
    for(let w=1; w<=total+1; w++){
      if(w===afterWeek+1){
        newPlan[cur]={}; DAYS.forEach(d=> newPlan[cur][d]={type:'rest',details:'',mileage:0}); cur++;
      }
      if(w<=total){ newPlan[cur]=plan[w]; cur++; }
    }
  }
  plan = newPlan;
  weeks = Object.keys(plan).length;
  renderTable();
}
function deleteWeek(weekToDelete){
  const newPlan={}; let cur=1;
  Object.keys(plan).forEach(w=>{
    if(Number(w)!==weekToDelete){ newPlan[cur]=plan[w]; cur++; }
  });
  plan=newPlan;
  weeks=Object.keys(plan).length;
  renderTable();
}

/* ===== Export / Import ===== */
function exportFile(){
  const data = {
    plan, title:planTitle, customWorkouts, showDates, startDate,
    savedDate:new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=(planTitle.replace(/\s+/g,'_')+'_training_plan.json');
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importFile(file){
  const r = new FileReader();
  r.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      plan = data.plan || {};
      planTitle = data.title || 'My Training Plan';
      customWorkouts = data.customWorkouts || [];
      ensureCustomColors(); // add colours if missing
      weeks = Object.keys(plan||{}).length;
      showDates = !!data.showDates;
      if(data.startDate) startDate = data.startDate;
      flashMsg('saveMsg','Plan loaded successfully!');
      enterApp();
    }catch(err){
      flashMsg('saveMsg','Error loading plan file.');
    }
  };
  r.readAsText(file);
}
function downloadPrintableHTML(){
  // Build print-ready HTML (landscape)
  let rows='';
  Object.keys(plan).forEach(week=>{
    let row = `<tr><td style="border:1px solid #ccc;padding:8px;font-weight:400;width:45px;text-align:center;vertical-align:middle;font-size:14px">${week}</td>`;
    DAYS.forEach((day, idx)=>{
      const c = plan[week][day];
      const map = {
        'bg-gray':'#f3f4f6','bg-blue':'#dbeafe','bg-purple':'#f3e8ff','bg-orange':'#fed7aa',
        'bg-red':'#fee2e2','bg-green':'#d1fae5','bg-yellow':'#fef3c7','bg-pink':'#fce7f3',
        'bg-indigo':'#e0e7ff','bg-cyan':'#cffafe','bg-lime':'#ecfccb','bg-amber':'#fef3c7',
        'bg-emerald':'#d1fae5','bg-teal':'#ccfbf1','bg-sky':'#e0f2fe','bg-violet':'#ede9fe',
        'bg-fuchsia':'#fae8ff','bg-rose':'#ffe4e6'
      };
      const bg = map[getWorkoutColor(c.type)] || '#f3f4f6';
      const details = c.details ? String(c.details).replace(/\n/g,'<br>') : '';
      const dateStr = (showDates && startDate) ? `<div style="font-size:10px;color:#6b7280;font-weight:600;margin-bottom:4px">${getDateForCell(week, idx)}</div>` : '';
      row += `<td style="border:1px solid #ccc;padding:8px;background:${bg};width:140px;vertical-align:top">
        ${dateStr}
        <div style="font-weight:700;font-size:12px">${getWorkoutLabel(c.type)}</div>
        ${Number(c.mileage)>0?`<div style="font-size:11px;margin-top:4px">${c.mileage}</div>`:''}
        ${details?`<div style="font-size:11px;margin-top:4px;color:#4b5563;word-wrap:break-word">${details}</div>`:''}
      </td>`;
    });
    row += `<td style="border:1px solid #ccc;padding:8px;text-align:center;font-weight:400;color:#111827;width:70px;vertical-align:middle;font-size:14px">${weeklyMileage(week)}</td></tr>`;
    rows += row;
  });

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>${escapeHtml(planTitle)}</title>
  <style>
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Noto Sans';margin:20px}
    h1{text-align:center;color:#1f2937;margin-bottom:20px}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th{background:#1f2937;color:#fff;padding:10px;border:1px solid #ccc;font-size:14px;text-align:center;vertical-align:middle;font-weight:400;line-height:1.6}
    th:first-child{width:45px}
    th:nth-child(n+2):nth-child(-n+8){width:140px}
    th:last-child{width:70px}
    td{font-size:11px}
    @page{size:landscape;margin:.5cm}
  </style></head>
  <body>
  <h1>${escapeHtml(planTitle)}</h1>
  <table>
    <thead>
      <tr>
        <th>Week</th>
        ${DAYS.map(d=>`<th>${d}</th>`).join('')}
        <th>Weekly<br/>Mileage</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  </table>
  </body></html>`;

  const blob = new Blob([html],{type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download=(planTitle.replace(/\s+/g,'_')+'_training_plan.html');
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);

  // Open hidden iframe to print immediately
  const f = document.createElement('iframe');
  f.style.display='none';
  document.body.appendChild(f);
  const doc = f.contentWindow.document;
  doc.open(); doc.write(html); doc.close();
  setTimeout(()=>{ f.contentWindow.print(); setTimeout(()=>document.body.removeChild(f),100); }, 500);
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ===== Events (Splash) ===== */
document.getElementById('createBtn').addEventListener('click', ()=>{
  const val = Number(document.getElementById('weeksInput').value||12);
  const n = Math.max(1, Math.min(52, isNaN(val)?12:val));
  weeks = n;
  plan = initEmptyPlan(n);
  planTitle = 'My Training Plan';
  customWorkouts = [];
  showDates = false;
  startDate = (new Date()).toISOString().split('T')[0];
  enterApp();
});
document.getElementById('loadSavedBtn').addEventListener('click', ()=> tryLoadSaved(true));
document.getElementById('importFile').addEventListener('change', e=>{
  if(e.target.files?.[0]) importFile(e.target.files[0]);
  e.target.value='';
});

/* ===== Events (App header) ===== */
document.getElementById('saveBtn').addEventListener('click', saveToLocal);
document.getElementById('exportBtn').addEventListener('click', exportFile);
document.getElementById('importFileTop').addEventListener('change', e=>{
  if(e.target.files?.[0]) importFile(e.target.files[0]);
  e.target.value='';
});
document.getElementById('downloadHtmlBtn').addEventListener('click', downloadPrintableHTML);
document.getElementById('newBtn').addEventListener('click', ()=>{
  plan = {};
  customWorkouts = [];
  planTitle = 'My Training Plan';
  showDates = false;
  startDate = (new Date()).toISOString().split('T')[0];
  renderSplash();
});

document.getElementById('startDate').addEventListener('change', e=>{
  startDate = e.target.value;
  if(startDate && !showDates){
    showDates = true;
    document.getElementById('showDatesSwitch').setAttribute('data-on','true');
  }
  renderTable();
});
document.getElementById('showDatesSwitch').addEventListener('click', e=>{
  showDates = !showDates;
  e.currentTarget.setAttribute('data-on', showDates?'true':'false');
  renderTable();
});

/* ===== Custom workouts ===== */
document.getElementById('addWorkoutBtn').addEventListener('click', addCustomWorkout);
document.getElementById('newWorkoutName').addEventListener('keydown', e=>{
  if(e.key==='Enter') addCustomWorkout();
});
document.getElementById('customWrap').addEventListener('click', e=>{
  const v = e.target.getAttribute('data-remove');
  if(!v) return;
  // remove from list
  customWorkouts = customWorkouts.filter(w=> w.value!==v);
  // replace any usage with 'rest' and set mileage 0
  Object.keys(plan).forEach(wk=>{
    DAYS.forEach(d=>{
      if(plan[wk][d].type===v){
        plan[wk][d].type='rest';
        plan[wk][d].mileage=0;
      }
    });
  });
  renderCustomList(); renderTable();
});

function addCustomWorkout(){
  const input = document.getElementById('newWorkoutName');
  const name = (input.value||'').trim();
  if(!name) return;
  if(allTypes().find(w=>w.label.toLowerCase()===name.toLowerCase())){ input.value=''; return; }
  const idx = customWorkouts.length % CUSTOM_COLORS.length;
  customWorkouts.push({ value:'custom_'+Date.now(), label:name, color:CUSTOM_COLORS[idx] });
  renderCustomList(); renderTable();
  input.value='';
}

/* ===== Boot ===== */
renderSplash();
</script>
</body>
</html>
